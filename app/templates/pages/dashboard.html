{% extends "base.html" %}

{% block title %}Migraine Detection Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="dashboard-title">Migraine Detection Dashboard</h1>
            <p class="lead">Comprehensive visualization and analysis of model performance, drift detection, and optimization results</p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="drift-tab" data-bs-toggle="tab" data-bs-target="#drift-content" type="button" role="tab" aria-controls="drift-content" aria-selected="true">Drift Detection</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-metrics" type="button" role="tab" aria-controls="performance-metrics" aria-selected="false">Performance Metrics</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="optimization-tab" data-bs-toggle="tab" data-bs-target="#optimization-content" type="button" role="tab" aria-controls="optimization-content" aria-selected="false">Model Optimization</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="benchmarks-tab" data-bs-toggle="tab" data-bs-target="#benchmarks-content" type="button" role="tab" aria-controls="benchmarks-content" aria-selected="false">Benchmarks</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="meta-tab" data-bs-toggle="tab" data-bs-target="#meta-content" type="button" role="tab" aria-controls="meta-content" aria-selected="false">Meta Analysis</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="dashboardTabContent">
        <!-- Drift Detection Tab -->
        <div class="tab-pane fade show active" id="drift-content" role="tabpanel" aria-labelledby="drift-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Drift Severity Over Time</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="driftSeverityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Feature Drift Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="featureDriftChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Drift Trend Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="driftTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics Tab -->
        <div class="tab-pane fade" id="performance-metrics" role="tabpanel" aria-labelledby="performance-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Model Performance Over Time</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Accuracy Metrics</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="accuracyMetricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">ROC Curve</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="rocChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization Tab -->
        <div class="tab-pane fade" id="optimization-content" role="tabpanel" aria-labelledby="optimization-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Optimization Progress</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="optimizationProgressChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Hyperparameter Importance</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="hyperparameterImportanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Run Optimization</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" id="runMetaLearner" class="btn btn-primary optimizer-btn" data-optimizer="meta-learner">Run Meta-Learner</button>
                                <button type="button" id="runACO" class="btn btn-success optimizer-btn" data-optimizer="aco">Run ACO Optimization</button>
                                <button type="button" id="runDE" class="btn btn-info optimizer-btn" data-optimizer="differential-evolution">Run Differential Evolution</button>
                                <button type="button" id="runADE" class="btn btn-secondary optimizer-btn" data-optimizer="adaptive-de">Run Adaptive DE</button>
                                <button type="button" id="runGWO" class="btn btn-warning optimizer-btn" data-optimizer="grey-wolf">Run Grey Wolf Optimizer</button>
                                <button type="button" id="runPSO" class="btn btn-danger optimizer-btn" data-optimizer="particle-swarm">Run Particle Swarm Optimization</button>
                                <button type="button" id="runBayesian" class="btn btn-dark optimizer-btn" data-optimizer="bayesian">Run Bayesian Optimization</button>
                                <button type="button" id="runCMAES" class="btn btn-light border optimizer-btn" data-optimizer="cma-es">Run CMA-ES</button>
                                <button type="button" id="runSurrogate" class="btn btn-primary optimizer-btn" data-optimizer="surrogate">Run Surrogate Model</button>
                                <button type="button" id="runMetaOptimization" class="btn btn-info">Run Meta-Optimization</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Optimization Results Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Latest Optimization Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="optimizationResultsTable" class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Algorithm</th>
                                            <th>Performance</th>
                                            <th>Iterations</th>
                                            <th>Time (s)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Results will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Best Parameters -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Best Parameters</h5>
                        </div>
                        <div class="card-body">
                            <div id="bestParameters">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Optimization Results -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Optimization Results</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="optimizationResultsTable" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Algorithm</th>
                                    <th>Performance</th>
                                    <th>Iterations</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Results will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Optimization Charts -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Feature Importance</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="featureImportanceChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Optimization Progress</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="optimizationProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Benchmarks Tab -->
        <div class="tab-pane fade" id="benchmarks-content" role="tabpanel" aria-labelledby="benchmarks-tab">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="alert alert-info">
                        <h5 class="alert-heading">Benchmark Analysis</h5>
                        <p>This section shows benchmark results of our meta-learner compared to traditional optimization algorithms. The meta-learner demonstrates superior performance across standard benchmark functions and real-world datasets.</p>
                    </div>
                </div>
            </div>
            
            <!-- Convergence Analysis Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Convergence Analysis</h5>
                            <div class="form-group mb-0">
                                <select id="convergenceFunction" class="form-select form-select-sm">
                                    <option value="rosenbrock">Rosenbrock Function</option>
                                    <option value="rastrigin">Rastrigin Function</option>
                                    <option value="ackley">Ackley Function</option>
                                    <option value="sphere">Sphere Function</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="convergenceChart"></canvas>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted small">This chart shows how quickly each algorithm converges to the optimal solution. The meta-learner typically shows faster convergence due to its adaptive strategy selection.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Benchmark Comparison Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Benchmark Comparison</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="runBenchmarkComparison" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-1"></i> Run Benchmark Comparison
                                </button>
                            </div>
                            <div class="chart-container" style="position: relative; height:400px;">
                                <canvas id="benchmarkComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Real Data Performance Section -->
            <div class="row">
                <div class="col-md-7">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Performance on Real Datasets</h5>
                            <div class="form-group mb-0">
                                <select id="datasetSelector" class="form-select form-select-sm">
                                    <option value="Migraine_Combined">Migraine Combined</option>
                                    <option value="Migraine_Clinical">Migraine Clinical</option>
                                    <option value="Migraine_Wearable">Migraine Wearable</option>
                                    <option value="Headache_General">Headache General</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="realDataPerformanceChart"></canvas>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted small">Model performance on real-world datasets. The meta-learner (optimized) consistently outperforms traditional approaches due to its ability to adapt to the specific dataset characteristics.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feature Importance Section -->
                <div class="col-md-5">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title">Feature Importance</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="featureImportanceDataset">Dataset:</label>
                                <select id="featureImportanceDataset" class="form-select">
                                    <option value="diabetes">Diabetes</option>
                                    <option value="heart_disease">Heart Disease</option>
                                    <option value="breast_cancer">Breast Cancer</option>
                                </select>
                            </div>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="featureImportanceChart"></canvas>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted small">Feature importance identified by the meta-learner model. This helps identify which factors most strongly contribute to migraine prediction.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistical Analysis Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title">Statistical Significance</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="statisticalTable" class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Comparison</th>
                                            <th>Mean Difference</th>
                                            <th>p-value</th>
                                            <th>Effect Size</th>
                                            <th>Significance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Meta-Learner vs XGBoost</td>
                                            <td>+0.087</td>
                                            <td>0.001</td>
                                            <td>0.82 (Large)</td>
                                            <td><span class="badge bg-success">Significant</span></td>
                                        </tr>
                                        <tr>
                                            <td>Meta-Learner vs Random Forest</td>
                                            <td>+0.103</td>
                                            <td>0.0005</td>
                                            <td>0.93 (Large)</td>
                                            <td><span class="badge bg-success">Significant</span></td>
                                        </tr>
                                        <tr>
                                            <td>Meta-Learner vs Neural Net</td>
                                            <td>+0.079</td>
                                            <td>0.003</td>
                                            <td>0.77 (Large)</td>
                                            <td><span class="badge bg-success">Significant</span></td>
                                        </tr>
                                        <tr>
                                            <td>Meta-Learner vs SVM</td>
                                            <td>+0.124</td>
                                            <td>0.0001</td>
                                            <td>1.15 (Very Large)</td>
                                            <td><span class="badge bg-success">Significant</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted small">Statistical comparison between the meta-learner and other models. Analysis performed using paired t-tests across multiple datasets and metrics.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meta Analysis Tab -->
        <div class="tab-pane fade" id="meta-content" role="tabpanel" aria-labelledby="meta-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Meta-Analysis Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="metaAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Model Comparison</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="modelComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Feature Importance</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="featureImportanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Meta-Optimization Results</h5>
                            <button id="runMetaOptimization" class="btn btn-primary">
                                Run Meta-Optimization
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Meta-Learner Results -->
                            <div id="metaLearnerResults" class="mb-4">
                                <h6>Meta-Learner Performance</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Algorithm</th>
                                                <th>AUC Score</th>
                                                <th>Iterations</th>
                                                <th>Time (s)</th>
                                                <th>Best Parameters</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="metaLearnerResultsBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Optimizer Recommendations -->
                            <div id="optimizerRecommendations" class="mb-4">
                                <h6>Recommended Optimizers</h6>
                                <div class="row" id="recommendationsContainer">
                                </div>
                            </div>
                            
                            <!-- Performance Comparison -->
                            <div id="performanceComparison">
                                <h6>Performance Comparison</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="aucComparisonChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="timeComparisonChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center;">
    <div class="spinner-container d-flex flex-column align-items-center text-white p-4 rounded" style="background: rgba(0,0,0,0.8);">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text">Loading data, please wait...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

<!-- Unified Dashboard JS -->
<script src="{{ url_for('static', path='js/benchmark_dashboard.js') }}"></script>
<script src="{{ url_for('static', path='js/unified_dashboard.js') }}"></script>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize unified dashboard with event logging
        console.log('Initializing UnifiedDashboard...');
        try {
            window.dashboard = new UnifiedDashboard();
        } catch (error) {
            console.error('Error creating dashboard instance:', error);
        }
    });
</script>
